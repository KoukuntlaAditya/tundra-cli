{"version":3,"sources":["../../../src/handlers/requests.js"],"names":["handleRequest","request","response","type","params","embeddedRequest","body","embeddedResponse","console","log","blue","method","url","yellow","statusCode","requestData","interceptedOn","Date","data","debugProfile","closestMatch","JSON","stringify","requests","concat","status","send","resetRequestsHandler","saveRequestsHandler","profileName","resetProfile","map","push","sortedRequests","chain","sortBy","value","green"],"mappings":";;;;;;;AAAA;;;;AACA;;AACA;;AACA;;;;AACA;;AACA;;;;;;;;AAEO,IAAMA;AAAA,qEAAgB,iBAAOC,OAAP,EAAgBC,QAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AACrBC,gBADqB,GACdF,QAAQG,MAAR,CAAeD,IAAf,GAAsBF,QAAQG,MAAR,CAAeD,IAArC,GAA4C,QAD9B;AAErBE,2BAFqB,GAEHJ,QAAQK,IAAR,CAAaL,OAFV;AAGrBM,4BAHqB,GAGFN,QAAQK,IAAR,CAAaJ,QAHX;;;AAK3BM,oBAAQC,GAAR,CACE,gBAAMC,IAAN,WAAmBP,IAAnB,UAA4BE,gBAAgBM,MAA5C,SAAsDN,gBAAgBO,GAAtE,UACA,gBAAMC,MAAN,QAAkBN,mBAAmBA,iBAAiBO,UAApC,GAAiD,aAAnE,QAFF;;AAKMC,uBAVqB,GAUP;AAClBZ,wBADkB;AAElBa,6BAAe,IAAIC,IAAJ,EAFG;AAGlBC,oBAAMjB,QAAQK;AAHI,aAVO;;AAAA,kBAgBvBH,SAAS,WAhBc;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAiBQ,0CAAuBF,QAAQK,IAA/B,EAAqC,uBAAWa,YAAhD,CAjBR;;AAAA;AAiBzBJ,wBAAYK,YAjBa;;AAAA;;AAoB3B,2CAAkBC,KAAKC,SAAL,CAAeP,WAAf,CAAlB;;AAEA,iCAAS,EAAEQ,UAAU,uBAAWA,QAAX,CAAoBC,MAApB,CAA2BT,WAA3B,CAAZ,EAAT;;AAEAb,qBAASuB,MAAT,CAAgB,GAAhB,EAAqBC,IAArB;;AAxB2B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAhB;;AAAA;AAAA;AAAA;AAAA,GAAN;;AA2BA,IAAMC,sDAAuB,SAAvBA,oBAAuB,CAAC1B,OAAD,EAAUC,QAAV,EAAuB;AACzD,uBAAS,EAAEqB,UAAU,EAAZ,EAAT;;AAEArB,WAASuB,MAAT,CAAgB,GAAhB,EAAqBC,IAArB;AACD,CAJM;;AAMA,IAAME;AAAA,sEAAsB,kBAAO3B,OAAP,EAAgBC,QAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAC3B2B,uBAD2B,GACb5B,QAAQK,IAAR,CAAauB,WADA;AAE3BC,wBAF2B,GAEZ7B,QAAQK,IAAR,CAAawB,YAFD;AAI7BP,oBAJ6B,GAIlB,uBAAWA,QAAX,CAAoBQ,GAApB,CAAwB;AAAA,qBAAW9B,QAAQiB,IAAnB;AAAA,aAAxB,CAJkB;;AAAA,gBAM5BY,YAN4B;AAAA;AAAA;AAAA;;AAAA,2BAO/BP,QAP+B,CAOtBS,IAPsB;AAAA,2BAO/BT,QAP+B;AAAA;AAAA;AAAA,mBAOR,yCAA2BM,WAA3B,CAPQ;;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAS3BI,0BAT2B,GASV,sBAAEV,QAAF,EAAYW,KAAZ,GACpBC,MADoB,CACb,gBADa,EAEpBA,MAFoB,CAEb,aAFa,EAGpBC,KAHoB,EATU;AAAA;AAAA,mBAc3B,oCAAsBH,cAAtB,EAAsCJ,WAAtC,CAd2B;;AAAA;;AAgBjCrB,oBAAQC,GAAR,CAAY,gBAAM4B,KAAN,qDAA8DR,WAA9D,gBAAZ;;AAEA3B,qBAASuB,MAAT,CAAgB,GAAhB,EAAqBC,IAArB;;AAlBiC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAtB;;AAAA;AAAA;AAAA;AAAA,GAAN","file":"requests.js","sourcesContent":["import chalk from 'chalk';\nimport { getState, setState } from '../services/state';\nimport { getExistingProfileRequests, saveRequestsAsProfile } from '../services/profile';\nimport _ from 'lodash';\nimport { sendSocketMessage } from '../services/socket';\nimport { getClosestProfileMatch } from '../services/closestMatch';\n\nexport const handleRequest = async (request, response) => {\n  const type = request.params.type ? request.params.type : 'normal';\n  const embeddedRequest = request.body.request;\n  const embeddedResponse = request.body.response;\n\n  console.log(\n    chalk.blue(`--> [${type}] ${embeddedRequest.method} ${embeddedRequest.url} `) +\n    chalk.yellow(`(${ embeddedResponse ? embeddedResponse.statusCode : 'No Response' })`)\n  );\n\n  const requestData = {\n    type,\n    interceptedOn: new Date(),\n    data: request.body\n  };\n\n  if (type === 'unmatched') {\n    requestData.closestMatch = await getClosestProfileMatch(request.body, getState().debugProfile);\n  }\n\n  sendSocketMessage(JSON.stringify(requestData));\n\n  setState({ requests: getState().requests.concat(requestData) });\n\n  response.status(201).send();\n};\n\nexport const resetRequestsHandler = (request, response) => {\n  setState({ requests: [] });\n\n  response.status(200).send();\n};\n\nexport const saveRequestsHandler = async (request, response) => {\n  const profileName = request.body.profileName;\n  const resetProfile = request.body.resetProfile;\n\n  let requests = getState().requests.map(request => request.data);\n\n  if (!resetProfile)\n    requests.push(...await getExistingProfileRequests(profileName));\n\n  const sortedRequests = _(requests).chain()\n    .sortBy('request.method')\n    .sortBy('request.url')\n    .value();\n\n  await saveRequestsAsProfile(sortedRequests, profileName);\n\n  console.log(chalk.green(`Captured requests successfully stored as the \\'${profileName}\\' profile`));\n\n  response.status(200).send();\n};\n\n\n"]}